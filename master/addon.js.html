<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding meta -->
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      addon.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/heading.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <div class="navbar-heading" id="navbar-heading"><a href="index.html"><h2 class="navbar-heading-text">Home</h2></a></div><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><div class="accordion collapsed" id="4362333" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=2938811><div class="accordion-heading child"><a href="module-node-openjtalk-binding.html">node-openjtalk-binding</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-node-openjtalk-binding.html#.readDictionary">readDictionary</a></li><li data-type='method'><a href="module-node-openjtalk-binding.html#.synthesis">synthesis</a></li></ul></li></ul> </div></div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        addon.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Simple binding of OpenJTalk.
 * @module node-openjtalk-binding
 */
const binary = require("@tignear/node-pre-gyp");
const path = require('path');
const meta = binary.meta(path.resolve(path.join(__dirname, './package.json')));
const { synthesis: _synthesis } = require(meta.module);
const { promises: fs } = require("fs");
const path_to_dictionary = path.resolve(path.join(meta.module_path, 'dictionary'));

/**
 * @typedef {Object} Dictionary
 * @property {Uint8Array|ArrayBuffer} unkdic unk.dic
 * @property {Uint8Array|ArrayBuffer} sysdic sys.dic
 * @property {Uint8Array|ArrayBuffer} property char.bin
 * @property {Uint8Array|ArrayBuffer} matrix matrix.bin
 */

/**
 * @typedef {Object} OpenJTalkOptions
 * @property {!string|Uint8Array|ArrayBuffer} htsvoice Path to htsvoice. Or data ArrayBuffer,Buffer.
 * @property {string|Dictionary} [dictionary] Dictionary object or Path to dictionary. NOT be URL nor Buffer. Must be encoded by UTF-8. The default is to use dictionary_dir.
 * @property {number} [sampling_frequency] Must be int. 1&lt;=sampling_frequency.
 * @property {number} [frame_period] Must be int. 1&lt;=frame_period.
 * @property {number} [all_pass_constant] 0.0&lt;=all_pass_constant&lt;=1.0.
 * @property {number} [postfiltering_coefficient] Default is 0.0. 0.0&lt;=postfiltering_coefficient&lt;=1.0.
 * @property {number} [speech_speed_rate] Default is 1.0. 0&lt;=speech_speed_rate. Warning: Do not set a very small value as it consumes CPU time.
 * @property {number} [additional_half_tone] Default is 0.0.
 * @property {number} [voiced_unvoiced_threshold] Default is 0.5. 0.0&lt;=voiced_unvoiced_threshold&lt;=1.0.
 * @property {number} [weight_of_GV_for_spectrum] Default is 1.0. 0.0&lt;=weight_of_GV_for_spectrum.
 * @property {number} [weight_of_GV_for_log_F0] Default is 1.0. 0.0&lt;=weight_of_GV_for_log_F0.
 * @property {number} [volume_in_dB] Default is 0.0.
 * @property {number} [audio_buffer_size] Disabled as default. 0 regarded disabled. 0&lt;=audio_buffer_size
 */

/**
 * @typedef {Object} WaveObject
 * @property {!Buffer} raw_data  Synthesized PCM by host byte order. 
 * @property {!Int16Array} data Synthesized PCM.
 * @property {!16} bitDepth LINEAR16.
 * @property {!number} sampleRate Equals to OpenJTalkOptions#sampling_frequency if presented for synthesis function. Else automatically determined value.
 * @property {!1} numChannels monaural.
 */

/**
 * Read mecab dictionary.
 * @async
 * @function
 * @static
 * @param {String} path_to_dictionary 
 * @returns {Promise&lt;Dictionary>}
 */
const readDictionary = exports.readDictionary = async function readDictionary(path_to_dictionary) {
  const [unkdic, sysdic, property, matrix] = (await Promise.all(
    [
      fs.readFile(path.resolve(path_to_dictionary, "unk.dic")),
      fs.readFile(path.resolve(path_to_dictionary, "sys.dic")),
      fs.readFile(path.resolve(path_to_dictionary, "char.bin")),
      fs.readFile(path.resolve(path_to_dictionary, "matrix.bin"))
    ]
  )).map(e => e.buffer);
  return {
    unkdic,
    sysdic,
    property,
    matrix
  };
}

const default_dictionary = readDictionary(path_to_dictionary);

/** 
 * Synthesis voice with OpenJTalk
 * @async
 * @function
 * @static
 * @param {string} text Text to synthesize.
 * @param {OpenJTalkOptions} options OpenJTalk synthesize option.
 * @return {Promise&lt;WaveObject>} Synthesized PCM.
 */
exports.synthesis = async function synthesis(text, options) {
  let htsvoice = options.htsvoice;
  if (typeof htsvoice === "string") {
    htsvoice = await fs.readFile(htsvoice);
  }
  if (htsvoice instanceof Uint8Array) {
    htsvoice = htsvoice.buffer;
  }
  let dictionary = options.dictionary;
  if (!dictionary) {
    dictionary = await default_dictionary;
  } else if (typeof dictionary == "string") {
    dictionary = await readDictionary(dictionary);
  } else {
    dictionary = Object.fromEntries(Object.entries(dictionary).map(([k, v]) => [k, v instanceof Uint8Array ? v.buffer : v]));
  }
  return new Promise((resolve, reject) => {
    if (!text) reject(new TypeError("The first argument must be a non-empty string"));
    function cb(err, /** @type {Buffer} */ buffer, /** @type {number} */ sampleRate) {
      if (err) {
        reject(err);
        return;
      }
      /**
       * @type {WaveObject}
       */
      const wave = {
        raw_data: buffer,
        data: new Int16Array(buffer.buffer),
        bitDepth: 16,
        numChannels: 1,
        sampleRate
      };
      resolve(wave);
    }
    try {
      _synthesis(cb, text, { ...options, htsvoice, dictionary });
    } catch (err) {
      reject(err);
    }
  });
}


/** 
 * Path to builded dictionary.
 * @type {string} 
 * */
exports.dictionary_dir = path_to_dictionary;
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"node-openjtalk-binding","link":"<a href=\"module-node-openjtalk-binding.html\">node-openjtalk-binding</a>"},{"title":"module:node-openjtalk-binding.readDictionary","link":"<a href=\"module-node-openjtalk-binding.html#.readDictionary\">module:node-openjtalk-binding.readDictionary &rtrif; undefined</a>"},{"title":"module:node-openjtalk-binding.synthesis","link":"<a href=\"module-node-openjtalk-binding.html#.synthesis\">module:node-openjtalk-binding.synthesis &rtrif; undefined</a>"}];
        var options = 
          setupSearch(list, options)
      </script>
    

    

    

    

    


  </body>

</html>